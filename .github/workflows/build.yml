name: "Build"
on:
  pull_request:
  pull_request_target:
  merge_group:
  push:
    branches:
      - master

jobs:
  build-agent:
    if: ${{ (( ! (github.event_name == 'pull_request_target') ) || (github.event.pull_request.author_association == 'MEMBER' || contains(github.event.pull_request.labels.*.name, 'trust')) ) && (( ! (github.event_name == 'pull_request') ) || ( ! (github.event.pull_request.author_association == 'MEMBER' || contains(github.event.pull_request.labels.*.name, 'trust')) )) }}
    runs-on: ubuntu-latest
    steps:
      # - if: ${{ github.event_name != 'pull_request_target' }}
      #   uses: actions/checkout@v4
      # - if: ${{ github.event_name == 'pull_request_target' }}
      #   uses: actions/checkout@v4
      #   with:
      #     ref: ${{ github.event.pull_request.merge_commit_sha }}
      - uses: actions/checkout@v4
        with:
          ref: ${{ (github.event_name == 'pull_request_target' && github.event.pull_request.merge_commit_sha) || '' }}
      - uses: ./.github/actions/setup-nix
        with:
          attic_token: ${{ secrets.ATTIC_TOKEN }}
      - uses: DeterminateSystems/magic-nix-cache-action@v9
      - name: build thymis-agent
        uses: ./.github/actions/run-command-with-nix-cache-upload
        with:
          attic_token: ${{ secrets.ATTIC_TOKEN }}
          script: |
            nix build .#thymis-agent --print-build-logs

  build-thymis-controller:
    if: ${{ (( ! (github.event_name == 'pull_request_target') ) || (github.event.pull_request.author_association == 'MEMBER' || contains(github.event.pull_request.labels.*.name, 'trust')) ) && (( ! (github.event_name == 'pull_request') ) || ( ! (github.event.pull_request.author_association == 'MEMBER' || contains(github.event.pull_request.labels.*.name, 'trust')) )) }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ (github.event_name == 'pull_request_target' && github.event.pull_request.merge_commit_sha) || '' }}
      - uses: ./.github/actions/setup-nix
        with:
          attic_token: ${{ secrets.ATTIC_TOKEN }}
      - uses: DeterminateSystems/magic-nix-cache-action@v9
      - name: build thymis-controller
        uses: ./.github/actions/run-command-with-nix-cache-upload
        with:
          attic_token: ${{ secrets.ATTIC_TOKEN }}
          script: |
            nix build .#thymis-controller --print-build-logs

  build-thymis-controller-pi-3-sd-image:
    if: ${{ (( ! (github.event_name == 'pull_request_target') ) || (github.event.pull_request.author_association == 'MEMBER' || contains(github.event.pull_request.labels.*.name, 'trust')) ) && (( ! (github.event_name == 'pull_request') ) || ( ! (github.event.pull_request.author_association == 'MEMBER' || contains(github.event.pull_request.labels.*.name, 'trust')) )) }}
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ (github.event_name == 'pull_request_target' && github.event.pull_request.merge_commit_sha) || '' }}
      - uses: ./.github/actions/setup-nix
        with:
          attic_token: ${{ secrets.ATTIC_TOKEN }}
      - uses: DeterminateSystems/magic-nix-cache-action@v9
      - name: run command with nix cache upload
        uses: ./.github/actions/run-command-with-nix-cache-upload
        with:
            script: |
              nix build .#thymis-controller-pi-3-sd-image --print-build-logs
      - uses: ./.github/actions/assemble-image-and-assert-existence

  build-thymis-controller-pi-4-sd-image:
    if: ${{ (( ! (github.event_name == 'pull_request_target') ) || (github.event.pull_request.author_association == 'MEMBER' || contains(github.event.pull_request.labels.*.name, 'trust')) ) && (( ! (github.event_name == 'pull_request') ) || ( ! (github.event.pull_request.author_association == 'MEMBER' || contains(github.event.pull_request.labels.*.name, 'trust')) )) }}
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ (github.event_name == 'pull_request_target' && github.event.pull_request.merge_commit_sha) || '' }}
      - uses: ./.github/actions/setup-nix
        with:
          attic_token: ${{ secrets.ATTIC_TOKEN }}
      - uses: DeterminateSystems/magic-nix-cache-action@v9
      - name: build thymis-controller-pi-4-sd-image
        uses: ./.github/actions/run-command-with-nix-cache-upload
        with:
          attic_token: ${{ secrets.ATTIC_TOKEN }}
          script: |
            nix build .#thymis-controller-pi-4-sd-image --print-build-logs
      - uses: ./.github/actions/assemble-image-and-assert-existence

  build-thymis-controller-pi-5-sd-image:
    if: ${{ (( ! (github.event_name == 'pull_request_target') ) || (github.event.pull_request.author_association == 'MEMBER' || contains(github.event.pull_request.labels.*.name, 'trust')) ) && (( ! (github.event_name == 'pull_request') ) || ( ! (github.event.pull_request.author_association == 'MEMBER' || contains(github.event.pull_request.labels.*.name, 'trust')) )) }}
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ (github.event_name == 'pull_request_target' && github.event.pull_request.merge_commit_sha) || '' }}
      - uses: ./.github/actions/setup-nix
        with:
          attic_token: ${{ secrets.ATTIC_TOKEN }}
      - uses: DeterminateSystems/magic-nix-cache-action@v9
      - name: build thymis-controller-pi-5-sd-image
        uses: ./.github/actions/run-command-with-nix-cache-upload
        with:
          attic_token: ${{ secrets.ATTIC_TOKEN }}
          script: |
            nix build .#thymis-controller-pi-5-sd-image --print-build-logs
      - uses: ./.github/actions/assemble-image-and-assert-existence

  build-generic-x86_64-image:
    if: ${{ (( ! (github.event_name == 'pull_request_target') ) || (github.event.pull_request.author_association == 'MEMBER' || contains(github.event.pull_request.labels.*.name, 'trust')) ) && (( ! (github.event_name == 'pull_request') ) || ( ! (github.event.pull_request.author_association == 'MEMBER' || contains(github.event.pull_request.labels.*.name, 'trust')) )) }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ (github.event_name == 'pull_request_target' && github.event.pull_request.merge_commit_sha) || '' }}
      - uses: ./.github/actions/setup-nix
        with:
          attic_token: ${{ secrets.ATTIC_TOKEN }}
      - uses: DeterminateSystems/magic-nix-cache-action@v9
      - name: pin nixpkgs
        run: nix registry add nixpkgs github:NixOS/nixpkgs/nixos-24.11
      - name: build thymis-controller-generic-x86_64-image
        uses: ./.github/actions/run-command-with-nix-cache-upload
        with:
          attic_token: ${{ secrets.ATTIC_TOKEN }}
          script: |
            nix build .#thymis-controller-generic-x86_64-image --print-build-logs
      - uses: ./.github/actions/assemble-image-and-assert-existence
